<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Paisa Watch</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<!-- Firebase config â€” hardcoded directly so no setup screen needed -->
<script>
  window.__PAISA_FIREBASE_CONFIG__ = {
    apiKey: "AIzaSyASg-WYbY8LazEBR41_a2gm-SH_XvZsgKM",
    authDomain: "paisa-watch.firebaseapp.com",
    projectId: "paisa-watch",
    storageBucket: "paisa-watch.firebasestorage.app",
    messagingSenderId: "229050469411",
    appId: "1:229050469411:web:78a8f88c5a8d4a021fb596",
    measurementId: "G-3HJ6MV2QEE"
  };
  try { localStorage.setItem('paisawatch_fbconfig', JSON.stringify(window.__PAISA_FIREBASE_CONFIG__)); } catch(e) {}
</script>
<!-- Firebase SDKs -->
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
import { getAuth, GoogleAuthProvider, signInWithRedirect, getRedirectResult, signOut, onAuthStateChanged }
  from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';
import { getFirestore, doc, getDoc, setDoc }
  from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

const FIREBASE_CONFIG = window.__PAISA_FIREBASE_CONFIG__ || null;
window.__FB__ = null;

if (FIREBASE_CONFIG) {
  try {
    const app      = initializeApp(FIREBASE_CONFIG);
    const auth     = getAuth(app);
    const db       = getFirestore(app);
    const provider = new GoogleAuthProvider();

    window.__FB__ = {
      signIn:   () => signInWithRedirect(auth, provider),
      getRedirectResult: () => getRedirectResult(auth),
      signOut:  () => signOut(auth),
      onAuth:   (cb) => onAuthStateChanged(auth, cb),
      saveData: async (uid, data) => {
        await setDoc(doc(db, 'users', uid), { state: JSON.stringify(data) });
      },
      loadData: async (uid) => {
        const snap = await getDoc(doc(db, 'users', uid));
        if (snap.exists()) return JSON.parse(snap.data().state);
        return null;
      },
    };
  } catch(e) {
    console.error('Firebase init error:', e);
  }
}

// Signal ready via callback â€” avoids event timing race
window.__FB_READY__ = true;
if (typeof window.__onFirebaseReady__ === 'function') window.__onFirebaseReady__();
</script>
<style>
:root {
  --bg:#0d0d0d; --surface:#161616; --s2:#1e1e1e; --border:#2a2a2a;
  --accent:#e8ff47; --a2:#ff6b35; --text:#f0f0f0; --muted:#666;
  --danger:#ff4444; --valid:#47ff8a; --stupid:#ff4444;
  --salary-clr:#a78bfa; --transfer-clr:#38bdf8;
  --food:#ff6b35; --entertainment:#a855f7; --groceries:#22d3ee;
  --party:#f59e0b; --gifts:#ec4899; --transport:#3b82f6;
  --impulse:#ef4444; --other:#6b7280;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);color:var(--text);font-family:'Syne',sans-serif;min-height:100vh;overflow-x:hidden;}
body::before{content:'';position:fixed;inset:0;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");pointer-events:none;z-index:0;opacity:.4;}
.app{position:relative;z-index:1;}

/* â”€â”€ HEADER â”€â”€ */
header{padding:13px 24px;display:flex;align-items:center;justify-content:space-between;gap:12px;border-bottom:1px solid var(--border);position:sticky;top:0;background:rgba(13,13,13,.94);backdrop-filter:blur(14px);z-index:100;}
.logo{font-family:'Space Mono',monospace;font-size:.95rem;font-weight:700;display:flex;align-items:center;gap:8px;flex-shrink:0;}
.logo-dot{width:8px;height:8px;background:var(--accent);border-radius:50%;animation:pulse 2s ease-in-out infinite;}
@keyframes pulse{0%,100%{transform:scale(1);opacity:1}50%{transform:scale(1.6);opacity:.5}}
.acc-switcher{display:flex;align-items:center;gap:6px;background:var(--s2);border:1px solid var(--border);border-radius:8px;padding:5px 10px;cursor:pointer;transition:border-color .2s;}
.acc-switcher:hover{border-color:var(--accent);}
.acc-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;}
.acc-name-hdr{font-family:'Space Mono',monospace;font-size:.72rem;font-weight:700;}
.acc-arrow{font-size:.7rem;color:var(--muted);}
.month-nav{display:flex;align-items:center;gap:8px;}
.mnb{background:var(--s2);border:1px solid var(--border);border-radius:6px;color:var(--text);cursor:pointer;font-family:'Space Mono',monospace;font-size:.78rem;padding:5px 9px;transition:all .2s;}
.mnb:hover{border-color:var(--accent);color:var(--accent);}
.month-lbl{font-family:'Space Mono',monospace;font-size:.78rem;font-weight:700;min-width:126px;text-align:center;}
.hdr-date{font-family:'Space Mono',monospace;font-size:.65rem;color:var(--muted);flex-shrink:0;}

/* â”€â”€ TABS â”€â”€ */
.main-tabs{display:flex;border-bottom:1px solid var(--border);background:var(--bg);position:sticky;top:54px;z-index:90;}
.main-tab{background:none;border:none;border-bottom:2px solid transparent;color:var(--muted);cursor:pointer;font-family:'Syne',sans-serif;font-size:.8rem;font-weight:700;letter-spacing:.04em;padding:10px 20px;transition:all .2s;}
.main-tab:hover{color:var(--text);}
.main-tab.active{border-bottom-color:var(--accent);color:var(--accent);}
.tab-panel{display:none;}.tab-panel.active{display:block;}

/* â”€â”€ LAYOUT â”€â”€ */
.layout{display:grid;grid-template-columns:355px 1fr;min-height:calc(100vh - 92px);}
.sidebar{border-right:1px solid var(--border);padding:20px;position:sticky;top:92px;height:calc(100vh - 92px);overflow-y:auto;scrollbar-width:none;}
.sidebar::-webkit-scrollbar{display:none;}

/* â”€â”€ FORM ELEMENTS â”€â”€ */
.slabel{font-family:'Space Mono',monospace;font-size:.58rem;letter-spacing:.15em;text-transform:uppercase;color:var(--muted);margin-bottom:9px;}
.fg{display:flex;flex-direction:column;gap:5px;margin-bottom:11px;}
label.lbl{font-size:.75rem;font-weight:600;color:var(--muted);}
input,select,textarea{background:var(--s2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:'Syne',sans-serif;font-size:.86rem;padding:8px 12px;outline:none;width:100%;transition:border-color .2s,box-shadow .2s;}
input:focus,select:focus,textarea:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(232,255,71,.07);}
input[type=date]{cursor:pointer;}
select option{background:#1e1e1e;}
textarea{resize:none;font-size:.81rem;}
.date-row{display:flex;gap:7px;}
.date-row input{flex:1;}
.today-btn{background:var(--s2);border:1px solid var(--border);border-radius:7px;color:var(--muted);cursor:pointer;font-family:'Syne',sans-serif;font-size:.68rem;font-weight:700;padding:8px 8px;white-space:nowrap;transition:all .2s;flex-shrink:0;}
.today-btn:hover{border-color:var(--accent);color:var(--accent);}
.date-hint{font-size:.66rem;color:var(--a2);min-height:13px;margin-top:2px;}
.divider{border:none;border-top:1px solid var(--border);margin:13px 0;}

/* â”€â”€ TYPE TOGGLE â”€â”€ */
.type-toggle{display:grid;grid-template-columns:1fr 1fr;border:1px solid var(--border);border-radius:8px;overflow:hidden;margin-bottom:10px;}
.type-btn{background:var(--s2);border:none;color:var(--muted);cursor:pointer;font-family:'Syne',sans-serif;font-size:.8rem;font-weight:700;padding:9px 6px;transition:all .2s;display:flex;align-items:center;justify-content:center;gap:5px;}
.type-btn:first-child{border-right:1px solid var(--border);}
.type-btn.valid-active{background:rgba(71,255,138,.12);color:var(--valid);}
.type-btn.stupid-active{background:rgba(255,68,68,.12);color:var(--stupid);}

/* â”€â”€ IMPULSE TOGGLE â”€â”€ */
.impulse-tog{display:flex;align-items:center;gap:8px;background:var(--s2);border:1px solid var(--border);border-radius:8px;cursor:pointer;padding:8px 12px;margin-bottom:11px;transition:border-color .2s;user-select:none;}
.impulse-tog:hover{border-color:var(--a2);}
.impulse-tog.active{border-color:var(--a2);background:rgba(255,107,53,.08);}
.imp-chk{width:15px;height:15px;border:2px solid var(--border);border-radius:4px;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .2s;font-size:.6rem;}
.impulse-tog.active .imp-chk{background:var(--a2);border-color:var(--a2);color:#fff;}
.imp-lbl{font-size:.8rem;font-weight:600;}
.impulse-tog.active .imp-lbl{color:var(--a2);}

/* â”€â”€ BUTTONS â”€â”€ */
.submit-btn{background:var(--accent);border:none;border-radius:8px;color:#000;cursor:pointer;font-family:'Syne',sans-serif;font-size:.87rem;font-weight:800;padding:12px;width:100%;transition:all .2s;}
.submit-btn:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(232,255,71,.3);}
.email-btn{background:transparent;border:1px solid var(--a2);border-radius:8px;color:var(--a2);cursor:pointer;font-family:'Syne',sans-serif;font-size:.8rem;font-weight:700;padding:9px;width:100%;transition:all .2s;}
.email-btn:hover{background:rgba(255,107,53,.1);}

/* â”€â”€ MAIN â”€â”€ */
.main{padding:20px;display:flex;flex-direction:column;gap:16px;}

/* â”€â”€ SALARY BAR â”€â”€ */
.salary-bar{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px 20px;}
.salary-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;gap:10px;flex-wrap:wrap;}
.salary-title{font-size:.8rem;font-weight:700;}
.salary-meta{display:flex;gap:16px;font-family:'Space Mono',monospace;font-size:.72rem;}
.salary-meta span{display:flex;flex-direction:column;gap:2px;}
.salary-meta .sm-lbl{color:var(--muted);font-size:.58rem;letter-spacing:.08em;text-transform:uppercase;}
.salary-meta .sm-val{font-weight:700;}
.salary-track{height:10px;background:var(--border);border-radius:99px;overflow:hidden;position:relative;}
.salary-fill{height:100%;border-radius:99px;transition:width .7s cubic-bezier(.4,0,.2,1);}
.salary-labels{display:flex;justify-content:space-between;margin-top:5px;font-family:'Space Mono',monospace;font-size:.62rem;color:var(--muted);}
.transfer-badge{background:rgba(56,189,248,.1);border:1px solid rgba(56,189,248,.25);border-radius:6px;color:var(--transfer-clr);font-size:.68rem;font-weight:700;padding:3px 8px;white-space:nowrap;}

/* â”€â”€ STATS â”€â”€ */
.stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:11px;}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:11px;padding:14px;position:relative;overflow:hidden;}
.stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;}
.sc-total::before{background:var(--accent);}
.sc-count::before{background:var(--a2);}
.sc-stupid::before{background:var(--stupid);}
.sc-top::before{background:#a855f7;}
.slbl{font-family:'Space Mono',monospace;font-size:.58rem;letter-spacing:.12em;color:var(--muted);text-transform:uppercase;margin-bottom:6px;}
.sval{font-size:1.4rem;font-weight:800;line-height:1;}
.ssub{font-size:.68rem;color:var(--muted);margin-top:4px;}

/* â”€â”€ CARDS â”€â”€ */
.card{background:var(--surface);border:1px solid var(--border);border-radius:11px;padding:17px;}
.card-title{font-size:.8rem;font-weight:700;margin-bottom:13px;display:flex;align-items:center;justify-content:space-between;}

/* â”€â”€ CAT BARS â”€â”€ */
.cat-bar-row{display:flex;align-items:center;gap:9px;margin-bottom:8px;}
.cat-name{font-size:.72rem;font-weight:600;width:105px;flex-shrink:0;}
.cat-bar-track{flex:1;height:6px;background:var(--border);border-radius:99px;overflow:hidden;}
.cat-bar-fill{height:100%;border-radius:99px;transition:width .6s cubic-bezier(.4,0,.2,1);}
.cat-amount{font-family:'Space Mono',monospace;font-size:.7rem;font-weight:700;width:60px;text-align:right;flex-shrink:0;}

/* â”€â”€ EXPENSE LIST â”€â”€ */
.list-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;gap:8px;flex-wrap:wrap;}
.filter-tabs{display:flex;gap:4px;flex-wrap:wrap;}
.ftab{background:transparent;border:1px solid var(--border);border-radius:6px;color:var(--muted);cursor:pointer;font-family:'Syne',sans-serif;font-size:.67rem;font-weight:600;padding:4px 9px;transition:all .2s;}
.ftab.active{background:var(--s2);border-color:var(--accent);color:var(--accent);}
.expense-item{display:grid;grid-template-columns:36px 1fr auto auto;gap:9px;align-items:center;padding:10px 0;border-bottom:1px solid var(--border);animation:fadeIn .22s ease;}
@keyframes fadeIn{from{opacity:0;transform:translateY(-4px)}to{opacity:1;transform:translateY(0)}}
.expense-item:last-child{border-bottom:none;}
.cat-pill{width:34px;height:34px;border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:.95rem;flex-shrink:0;}
.exp-info{min-width:0;}
.exp-merchant{font-size:.85rem;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.exp-meta{font-size:.68rem;color:var(--muted);display:flex;gap:6px;margin-top:2px;flex-wrap:wrap;}
.exp-comment{font-size:.68rem;color:#888;font-style:italic;margin-top:3px;line-height:1.4;border-left:2px solid var(--border);padding-left:7px;}
.exp-badges{display:flex;gap:4px;margin-top:3px;flex-wrap:wrap;}
.badge{font-size:.56rem;padding:2px 6px;border-radius:4px;font-weight:700;letter-spacing:.04em;text-transform:uppercase;}
.badge.valid{background:rgba(71,255,138,.12);color:var(--valid);}
.badge.stupid{background:rgba(255,68,68,.12);color:var(--stupid);}
.badge.impulse{background:rgba(255,107,53,.12);color:var(--a2);}
.badge.transfer-out{background:rgba(56,189,248,.1);color:var(--transfer-clr);}
.exp-amount{font-family:'Space Mono',monospace;font-size:.85rem;font-weight:700;flex-shrink:0;}
.del-btn{background:none;border:none;color:var(--muted);cursor:pointer;font-size:.75rem;padding:4px;border-radius:4px;transition:color .2s;}
.del-btn:hover{color:var(--danger);}
.empty-state{text-align:center;padding:30px;color:var(--muted);}
.empty-icon{font-size:1.9rem;margin-bottom:8px;}
.empty-text{font-size:.78rem;}

/* â”€â”€ WARNING â”€â”€ */
.warn-banner{background:rgba(255,68,68,.08);border:1px solid rgba(255,68,68,.25);border-radius:10px;padding:9px 14px;font-size:.75rem;color:#ff8888;display:none;align-items:center;gap:9px;}
.warn-banner.show{display:flex;}

/* â”€â”€ COLORS â”€â”€ */
.c-food{color:var(--food)}.c-entertainment{color:var(--entertainment)}.c-groceries{color:var(--groceries)}
.c-party{color:var(--party)}.c-gifts{color:var(--gifts)}.c-transport{color:var(--transport)}
.c-impulse{color:var(--impulse)}.c-other{color:var(--other)}.c-transfer{color:var(--transfer-clr)}
.bg-food{background:rgba(255,107,53,.12)}.bg-entertainment{background:rgba(168,85,247,.12)}
.bg-groceries{background:rgba(34,211,238,.12)}.bg-party{background:rgba(245,158,11,.12)}
.bg-gifts{background:rgba(236,72,153,.12)}.bg-transport{background:rgba(59,130,246,.12)}
.bg-impulse{background:rgba(239,68,68,.12)}.bg-other{background:rgba(107,114,128,.12)}
.bg-transfer{background:rgba(56,189,248,.1)}
.bar-food{background:var(--food)}.bar-entertainment{background:var(--entertainment)}
.bar-groceries{background:var(--groceries)}.bar-party{background:var(--party)}
.bar-gifts{background:var(--gifts)}.bar-transport{background:var(--transport)}
.bar-impulse{background:var(--impulse)}.bar-other{background:var(--other)}

/* â”€â”€ CHARTS â”€â”€ */
.charts-layout{padding:20px;display:grid;grid-template-columns:1fr 1fr;gap:16px;}
.chart-card{background:var(--surface);border:1px solid var(--border);border-radius:11px;padding:17px;}
.chart-card.wide{grid-column:span 2;}
.chart-title{font-size:.8rem;font-weight:700;margin-bottom:14px;}
.donut-wrap{display:flex;align-items:center;gap:18px;}
.donut-legend{flex:1;display:flex;flex-direction:column;gap:6px;}
.legend-item{display:flex;align-items:center;gap:7px;font-size:.72rem;}
.legend-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
.legend-label{color:var(--muted);flex:1;}
.legend-val{font-family:'Space Mono',monospace;font-size:.68rem;font-weight:700;}
.vs-bar-wrap{display:flex;flex-direction:column;gap:9px;}
.vs-row{display:flex;align-items:center;gap:9px;}
.vs-lbl{font-size:.75rem;font-weight:700;width:66px;flex-shrink:0;}
.vs-track{flex:1;height:9px;background:var(--border);border-radius:99px;overflow:hidden;}
.vs-fill{height:100%;border-radius:99px;transition:width .7s cubic-bezier(.4,0,.2,1);}
.vs-fill.vf{background:var(--valid)}.vs-fill.sf{background:var(--stupid)}
.vs-amt{font-family:'Space Mono',monospace;font-size:.69rem;font-weight:700;width:56px;text-align:right;flex-shrink:0;}
.daily-bars{display:flex;align-items:flex-end;gap:2px;height:85px;}
.daily-col{display:flex;flex-direction:column;align-items:center;gap:3px;flex:1;min-width:0;}
.daily-bar{width:100%;border-radius:3px 3px 0 0;min-height:2px;position:relative;cursor:pointer;}
.daily-bar:hover::after{content:attr(data-tip);position:absolute;bottom:calc(100% + 4px);left:50%;transform:translateX(-50%);background:var(--s2);border:1px solid var(--border);border-radius:5px;font-family:'Space Mono',monospace;font-size:.6rem;padding:3px 7px;white-space:nowrap;z-index:10;}
.daily-day{font-family:'Space Mono',monospace;font-size:.48rem;color:var(--muted);}

/* â”€â”€ ACCOUNTS MODAL â”€â”€ */
.acc-modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.8);backdrop-filter:blur(6px);z-index:300;display:none;align-items:center;justify-content:center;}
.acc-modal-overlay.show{display:flex;}
.acc-modal{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:24px;width:460px;max-width:93vw;max-height:90vh;overflow-y:auto;}
.acc-modal-title{font-size:.95rem;font-weight:800;margin-bottom:18px;display:flex;align-items:center;gap:10px;}
.modal-close{background:none;border:none;color:var(--muted);cursor:pointer;font-size:.95rem;margin-left:auto;}
.acc-list{display:flex;flex-direction:column;gap:8px;margin-bottom:14px;}
.acc-item{background:var(--s2);border:1px solid var(--border);border-radius:9px;padding:12px 14px;display:flex;align-items:center;gap:10px;cursor:pointer;transition:border-color .2s;}
.acc-item:hover{border-color:var(--accent);}
.acc-item.active-acc{border-color:var(--accent);background:rgba(232,255,71,.05);}
.acc-item-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;}
.acc-item-info{flex:1;min-width:0;}
.acc-item-name{font-size:.85rem;font-weight:700;}
.acc-item-meta{font-size:.7rem;color:var(--muted);margin-top:2px;}
.acc-item-check{color:var(--accent);font-size:.9rem;}
.acc-add-form{background:var(--s2);border:1px solid var(--border);border-radius:9px;padding:14px;}
.acc-add-title{font-size:.75rem;font-weight:700;margin-bottom:10px;color:var(--muted);}
.acc-add-row{display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap;}
.acc-add-row input{flex:1;min-width:100px;}
.color-picker-row{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px;}
.color-dot-pick{width:22px;height:22px;border-radius:50%;cursor:pointer;border:2px solid transparent;transition:border-color .2s;flex-shrink:0;}
.color-dot-pick.selected{border-color:#fff;}
.salary-settings{background:var(--s2);border:1px solid var(--border);border-radius:9px;padding:14px;margin-bottom:14px;}
.sal-set-title{font-size:.75rem;font-weight:700;color:var(--muted);margin-bottom:10px;}
.sal-row{display:flex;gap:8px;align-items:flex-end;flex-wrap:wrap;}
.sal-row .fg{flex:1;min-width:100px;margin-bottom:0;}
.sal-override-list{margin-top:10px;display:flex;flex-direction:column;gap:6px;}
.sal-override-item{display:flex;align-items:center;gap:8px;font-size:.75rem;font-family:'Space Mono',monospace;background:rgba(167,139,250,.07);border:1px solid rgba(167,139,250,.2);border-radius:6px;padding:6px 10px;}
.sal-override-item span{flex:1;}
.sal-del{background:none;border:none;color:var(--muted);cursor:pointer;font-size:.75rem;transition:color .2s;}
.sal-del:hover{color:var(--danger);}

/* â”€â”€ REPORT MODAL â”€â”€ */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);backdrop-filter:blur(5px);z-index:200;display:none;align-items:center;justify-content:center;}
.modal-overlay.show{display:flex;}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:13px;padding:22px;width:430px;max-width:92vw;}
.modal-title{font-size:.9rem;font-weight:800;margin-bottom:13px;display:flex;align-items:center;gap:10px;}
.report-preview{background:var(--bg);border:1px solid var(--border);border-radius:8px;font-family:'Space Mono',monospace;font-size:.65rem;line-height:1.85;padding:12px;white-space:pre;overflow-x:auto;max-height:250px;overflow-y:auto;margin-bottom:12px;color:#aaa;}
.modal-actions{display:flex;gap:9px;}
.modal-btn{flex:1;border-radius:8px;cursor:pointer;font-family:'Syne',sans-serif;font-size:.8rem;font-weight:700;padding:9px;transition:all .2s;}
.modal-btn.primary{background:var(--accent);border:none;color:#000;}
.modal-btn.primary:hover{box-shadow:0 4px 14px rgba(232,255,71,.3);}
.modal-btn.secondary{background:transparent;border:1px solid var(--border);color:var(--text);}
.modal-btn.secondary:hover{border-color:var(--muted);}

/* â”€â”€ IMPORT TAB â”€â”€ */
.import-layout{padding:24px;max-width:880px;margin:0 auto;display:flex;flex-direction:column;gap:18px;}
.import-title{font-size:1.2rem;font-weight:800;margin-bottom:5px;}
.import-sub{font-size:.8rem;color:var(--muted);line-height:1.6;}
.import-box{background:var(--surface);border:1px solid var(--border);border-radius:11px;padding:20px;}
.import-controls{display:flex;gap:10px;align-items:flex-end;margin-bottom:14px;flex-wrap:wrap;}
.import-date-wrap{display:flex;flex-direction:column;gap:4px;}
.import-date-lbl{font-size:.7rem;font-weight:600;color:var(--muted);}
.import-date-inp{background:var(--s2);border:1px solid var(--border);border-radius:7px;color:var(--text);font-family:'Syne',sans-serif;font-size:.83rem;padding:8px 11px;outline:none;width:165px;transition:border-color .2s;}
.import-date-inp:focus{border-color:var(--accent);}
.import-textarea{background:var(--s2);border:1px solid var(--border);border-radius:9px;color:var(--text);font-family:'Space Mono',monospace;font-size:.76rem;line-height:1.8;outline:none;padding:14px;resize:vertical;width:100%;min-height:230px;transition:border-color .2s;margin-bottom:13px;}
.import-textarea:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(232,255,71,.06);}
.import-parse-btn{background:var(--accent);border:none;border-radius:8px;color:#000;cursor:pointer;font-family:'Syne',sans-serif;font-size:.87rem;font-weight:800;padding:11px 22px;transition:all .2s;}
.import-parse-btn:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(232,255,71,.3);}
.example-lbl{font-family:'Syne',sans-serif;font-size:.7rem;font-weight:700;color:var(--muted);margin-bottom:7px;letter-spacing:.07em;text-transform:uppercase;}
.example-card{background:var(--s2);border:1px solid var(--border);border-radius:9px;padding:15px;font-family:'Space Mono',monospace;font-size:.7rem;line-height:2;color:#888;white-space:pre-wrap;}
.hl{color:var(--accent);}
.preview-box{background:var(--surface);border:1px solid var(--border);border-radius:11px;overflow:hidden;}
.preview-header{padding:14px 18px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);gap:10px;flex-wrap:wrap;}
.preview-title{font-size:.82rem;font-weight:700;}
.preview-count{font-family:'Space Mono',monospace;font-size:.7rem;color:var(--accent);}
.preview-actions{display:flex;gap:7px;}
.prev-confirm{background:var(--accent);border:none;border-radius:7px;color:#000;cursor:pointer;font-family:'Syne',sans-serif;font-size:.78rem;font-weight:800;padding:7px 14px;transition:all .2s;}
.prev-confirm:hover{box-shadow:0 4px 12px rgba(232,255,71,.3);}
.prev-cancel{background:transparent;border:1px solid var(--border);border-radius:7px;color:var(--muted);cursor:pointer;font-family:'Syne',sans-serif;font-size:.78rem;font-weight:700;padding:7px 12px;transition:all .2s;}
.prev-cancel:hover{border-color:var(--danger);color:var(--danger);}
.preview-table{width:100%;border-collapse:collapse;}
.preview-table th{font-family:'Space Mono',monospace;font-size:.58rem;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);padding:9px 12px;text-align:left;border-bottom:1px solid var(--border);background:var(--s2);}
.preview-table td{padding:9px 12px;font-size:.78rem;border-bottom:1px solid var(--border);vertical-align:middle;}
.preview-table tr:last-child td{border-bottom:none;}
.preview-table tr:hover td{background:rgba(255,255,255,.015);}
.ec{background:var(--s2);border:1px solid transparent;border-radius:5px;color:var(--text);font-family:'Syne',sans-serif;font-size:.76rem;padding:3px 6px;outline:none;width:100%;transition:border-color .2s;}
.ec:focus{border-color:var(--accent);}
select.ec{cursor:pointer;}select.ec option{background:#1e1e1e;}
.type-pill{border:none;border-radius:5px;cursor:pointer;font-family:'Syne',sans-serif;font-size:.67rem;font-weight:700;padding:4px 8px;transition:all .2s;white-space:nowrap;}
.type-pill.valid{background:rgba(71,255,138,.12);color:var(--valid);}
.type-pill.stupid{background:rgba(255,68,68,.12);color:var(--stupid);}
.type-pill.transfer-out{background:rgba(56,189,248,.1);color:var(--transfer-clr);}
.rm-row{background:none;border:none;color:var(--muted);cursor:pointer;font-size:.75rem;padding:3px 5px;border-radius:4px;transition:color .2s;}
.rm-row:hover{color:var(--danger);}
.comment-preview{font-size:.66rem;color:#777;font-style:italic;max-width:180px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}

/* â”€â”€ TOAST â”€â”€ */
.toast{position:fixed;bottom:20px;right:20px;background:var(--s2);border:1px solid var(--accent);border-radius:9px;padding:10px 15px;font-size:.78rem;font-weight:600;z-index:999;transform:translateY(60px);opacity:0;transition:all .3s cubic-bezier(.4,0,.2,1);}
.toast.show{transform:translateY(0);opacity:1;}
.toast.error{border-color:var(--danger);}

/* â”€â”€ LOGIN / AUTH SCREEN â”€â”€ */
#authScreen {
  position:fixed;inset:0;background:var(--bg);z-index:1000;
  display:flex;align-items:center;justify-content:center;
  font-family:'Syne',sans-serif;
}
#authScreen.hidden{display:none;}
.auth-card {
  width:380px;max-width:93vw;
  background:var(--surface);border:1px solid var(--border);border-radius:16px;
  padding:36px 32px;text-align:center;position:relative;overflow:hidden;
}
.auth-card::before {
  content:'';position:absolute;top:0;left:0;right:0;height:3px;
  background:linear-gradient(90deg,var(--accent),var(--a2),#a855f7);
}
.auth-logo {
  font-family:'Space Mono',monospace;font-size:1.3rem;font-weight:700;
  display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:8px;
}
.auth-logo-dot{width:11px;height:11px;background:var(--accent);border-radius:50%;animation:pulse 2s ease-in-out infinite;}
.auth-tagline{font-size:.78rem;color:var(--muted);margin-bottom:32px;line-height:1.5;}
.auth-divider{border:none;border-top:1px solid var(--border);margin:24px 0;position:relative;}
.auth-divider::after{content:'or';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--surface);padding:0 10px;font-size:.68rem;color:var(--muted);}
.google-btn {
  width:100%;background:#fff;border:none;border-radius:9px;
  color:#1f1f1f;cursor:pointer;font-family:'Syne',sans-serif;
  font-size:.88rem;font-weight:700;padding:13px 18px;
  display:flex;align-items:center;justify-content:center;gap:11px;
  transition:all .2s;margin-bottom:10px;
}
.google-btn:hover{transform:translateY(-1px);box-shadow:0 6px 22px rgba(255,255,255,.15);}
.google-btn:active{transform:translateY(0);}
.google-icon{width:20px;height:20px;flex-shrink:0;}
.auth-note{font-size:.67rem;color:var(--muted);line-height:1.5;margin-top:8px;}

/* Setup config card */
.setup-card {
  width:500px;max-width:95vw;
  background:var(--surface);border:1px solid var(--border);border-radius:16px;
  padding:28px;text-align:left;
}
.setup-card::before {
  content:'';display:block;height:3px;
  background:linear-gradient(90deg,var(--accent),var(--a2));
  border-radius:3px;margin-bottom:22px;
}
.setup-title{font-size:1rem;font-weight:800;margin-bottom:6px;}
.setup-sub{font-size:.76rem;color:var(--muted);line-height:1.65;margin-bottom:18px;}
.setup-steps{display:flex;flex-direction:column;gap:10px;margin-bottom:18px;}
.setup-step{display:flex;gap:11px;align-items:flex-start;}
.step-num{width:22px;height:22px;background:var(--accent);border-radius:50%;color:#000;font-size:.65rem;font-weight:800;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:1px;}
.step-text{font-size:.75rem;color:var(--text);line-height:1.55;}
.step-text code{font-family:'Space Mono',monospace;font-size:.68rem;background:var(--s2);padding:1px 5px;border-radius:4px;color:var(--accent);}
.setup-textarea {
  width:100%;min-height:110px;background:var(--s2);border:1px solid var(--border);
  border-radius:9px;color:var(--accent);font-family:'Space Mono',monospace;
  font-size:.72rem;line-height:1.8;padding:12px;outline:none;resize:vertical;
  margin-bottom:12px;transition:border-color .2s;
}
.setup-textarea:focus{border-color:var(--accent);}
.setup-textarea::placeholder{color:var(--muted);}
.setup-btn{background:var(--accent);border:none;border-radius:8px;color:#000;cursor:pointer;font-family:'Syne',sans-serif;font-size:.87rem;font-weight:800;padding:11px 20px;transition:all .2s;width:100%;}
.setup-btn:hover{box-shadow:0 5px 18px rgba(232,255,71,.3);}
.setup-skip{background:none;border:none;color:var(--muted);cursor:pointer;font-family:'Syne',sans-serif;font-size:.72rem;width:100%;margin-top:8px;padding:6px;transition:color .2s;}
.setup-skip:hover{color:var(--text);}

/* User avatar in header */
.user-pill{display:flex;align-items:center;gap:7px;background:var(--s2);border:1px solid var(--border);border-radius:8px;padding:4px 10px;cursor:pointer;transition:border-color .2s;flex-shrink:0;}
.user-pill:hover{border-color:var(--accent);}
.user-avatar{width:22px;height:22px;border-radius:50%;object-fit:cover;flex-shrink:0;}
.user-avatar-placeholder{width:22px;height:22px;border-radius:50%;background:var(--accent);display:flex;align-items:center;justify-content:center;font-size:.65rem;font-weight:800;color:#000;flex-shrink:0;}
.user-name{font-family:'Space Mono',monospace;font-size:.68rem;font-weight:700;max-width:90px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.signout-btn{font-size:.6rem;color:var(--muted);background:none;border:none;cursor:pointer;font-family:'Syne',sans-serif;padding:0;transition:color .2s;}
.signout-btn:hover{color:var(--danger);}
.saving-dot{width:6px;height:6px;border-radius:50%;background:var(--accent);animation:pulse 1s infinite;flex-shrink:0;display:none;}
.saving-dot.active{display:block;}

@media(max-width:900px){
  .layout{grid-template-columns:1fr;}
  .sidebar{position:static;height:auto;}
  .stats-row{grid-template-columns:1fr 1fr;}
  .charts-layout{grid-template-columns:1fr;}
  .chart-card.wide{grid-column:span 1;}
  .donut-wrap{flex-direction:column;}
}
</style>
</head>
<body>
<!-- â”€â”€ AUTH / LOGIN SCREEN â”€â”€ -->
<div id="authScreen">
  <!-- shown while checking auth state â€” visible by default -->
  <div id="authLoading" style="text-align:center;">
    <div style="font-family:'Space Mono',monospace;font-size:.8rem;color:var(--muted);">
      <div style="width:10px;height:10px;background:var(--accent);border-radius:50%;animation:pulse 1s infinite;margin:0 auto 12px;"></div>
      Loadingâ€¦
    </div>
  </div>

  <!-- login card -->
  <div id="loginCard" class="auth-card" style="display:none;">
    <div class="auth-logo"><div class="auth-logo-dot"></div>Paisa Watch</div>
    <div class="auth-tagline">Your personal finance tracker.<br>Sign in to sync your data across devices.</div>
    <button class="google-btn" onclick="doSignIn()">
      <svg class="google-icon" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
      Continue with Google
    </button>
    <div class="auth-note">Your data is stored privately under your Google account.<br>No one else can see your expenses.</div>
  </div>

  <!-- firebase setup card (shown when no config) -->
  <div id="setupCard" class="setup-card" style="display:none;">
    <div class="setup-title">âš™ï¸ One-time Firebase Setup</div>
    <div class="setup-sub">Paisa Watch uses Firebase for free, private cloud storage. This takes about 5 minutes and you only do it once. Your config key is never shared.</div>
    <div class="setup-steps">
      <div class="setup-step"><div class="step-num">1</div><div class="step-text">Go to <code>console.firebase.google.com</code> and create a new project (free Spark plan)</div></div>
      <div class="setup-step"><div class="step-num">2</div><div class="step-text">Enable <strong>Authentication</strong> â†’ Sign-in method â†’ <strong>Google</strong></div></div>
      <div class="setup-step"><div class="step-num">3</div><div class="step-text">Enable <strong>Firestore Database</strong> â†’ Create in production mode â†’ choose any region</div></div>
      <div class="setup-step"><div class="step-num">4</div><div class="step-text">Go to <strong>Project Settings</strong> â†’ Your apps â†’ Add app (Web) â†’ copy the <code>firebaseConfig</code> object and paste it below</div></div>
    </div>
    <textarea class="setup-textarea" id="configInput" placeholder='{
  "apiKey": "AIza...",
  "authDomain": "yourapp.firebaseapp.com",
  "projectId": "yourapp",
  "storageBucket": "yourapp.appspot.com",
  "messagingSenderId": "123456789",
  "appId": "1:123...:web:abc..."
}'></textarea>
    <button class="setup-btn" onclick="applyConfig()">âœ… Save Config & Continue</button>
    <button class="setup-skip" onclick="skipToLocal()">Use locally without login (data stays on this device only)</button>
  </div>
</div>

<div class="app" id="mainApp" style="display:none;">

<!-- â”€â”€ HEADER â”€â”€ -->
<header>
  <div class="logo"><div class="logo-dot"></div>Paisa Watch</div>
  <div class="acc-switcher" onclick="openAccModal()">
    <div class="acc-dot" id="hdr-acc-dot"></div>
    <span class="acc-name-hdr" id="hdr-acc-name">â€”</span>
    <span class="acc-arrow">â–¾</span>
  </div>
  <div class="month-nav">
    <button class="mnb" onclick="changeMonth(-1)">â†</button>
    <div class="month-lbl" id="monthLabel">â€”</div>
    <button class="mnb" onclick="changeMonth(1)">â†’</button>
  </div>
  <div class="hdr-date" id="headerDate">â€”</div>
  <div class="user-pill" onclick="toggleUserMenu()" id="userPill" style="display:none;">
    <div class="user-avatar-placeholder" id="userAvatar">?</div>
    <span class="user-name" id="userName">â€”</span>
    <div class="saving-dot" id="savingDot"></div>
  </div>
</header>

<!-- â”€â”€ USER MENU â”€â”€ -->
<div id="userMenu" style="display:none;position:fixed;top:58px;right:16px;background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:12px 16px;z-index:150;min-width:180px;box-shadow:0 8px 30px rgba(0,0,0,.5);">
  <div style="font-size:.72rem;color:var(--muted);margin-bottom:4px;">Signed in as</div>
  <div style="font-size:.8rem;font-weight:700;margin-bottom:12px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" id="userMenuEmail">â€”</div>
  <button onclick="doSignOut()" style="background:rgba(255,68,68,.1);border:1px solid rgba(255,68,68,.2);border-radius:6px;color:var(--danger);cursor:pointer;font-family:'Syne',sans-serif;font-size:.75rem;font-weight:700;padding:7px 12px;width:100%;transition:all .2s;">Sign Out</button>
</div>

<!-- â”€â”€ TABS â”€â”€ -->
<div class="main-tabs">
  <button class="main-tab active" onclick="switchTab('dashboard',this)">ğŸ“‹ Dashboard</button>
  <button class="main-tab" onclick="switchTab('charts',this)">ğŸ“Š Charts</button>
  <button class="main-tab" onclick="switchTab('import',this)">ğŸ“¥ Import</button>
</div>

<!-- â•â•â•â•â•â•â•â• DASHBOARD â•â•â•â•â•â•â•â• -->
<div id="tab-dashboard" class="tab-panel active">
  <div class="layout">
    <aside class="sidebar">
      <div class="slabel">Log Expense</div>
      <div class="fg">
        <label class="lbl">ğŸ“… Date <span style="color:var(--accent);font-size:.65rem;font-weight:400;">(backdate freely)</span></label>
        <div class="date-row">
          <input type="date" id="inp-date" oninput="updateDateHint()">
          <button class="today-btn" onclick="setToday()">Today</button>
        </div>
        <div class="date-hint" id="dateHint"></div>
      </div>
      <div class="fg"><label class="lbl">Category</label>
        <select id="inp-category">
          <option value="Food">ğŸ” Food</option>
          <option value="Groceries">ğŸ›’ Groceries</option>
          <option value="Entertainment">ğŸ® Entertainment</option>
          <option value="Party">ğŸ‰ Party</option>
          <option value="Gifts">ğŸ Gifts</option>
          <option value="Transport">ğŸšŒ Transport</option>
          <option value="Impulse">âš¡ Impulse Buy</option>
          <option value="Transfer">ğŸ”„ Transfer</option>
          <option value="Other">ğŸ“¦ Other</option>
        </select>
      </div>
      <div class="fg"><label class="lbl">Merchant / App</label><input type="text" id="inp-merchant" placeholder="Zomato, BlinkIt, eFootballâ€¦"></div>
      <div class="fg"><label class="lbl">Amount (â‚¹)</label><input type="number" id="inp-amount" placeholder="0.00" min="0" step="0.01"></div>
      <div class="fg"><label class="lbl">Comment / Note</label><textarea id="inp-note" rows="2" placeholder="Why? Be honest. Any remindersâ€¦"></textarea></div>

      <div class="slabel" style="margin-bottom:7px;">Was this spendâ€¦</div>
      <div class="type-toggle">
        <button class="type-btn valid-active" id="type-valid" onclick="setType('valid')">âœ… Valid</button>
        <button class="type-btn" id="type-stupid" onclick="setType('stupid')">ğŸ¤¦ Stupid</button>
      </div>
      <div class="impulse-tog" id="impulseTog" onclick="toggleImpulse()">
        <div class="imp-chk" id="impChk"></div>
        <span class="imp-lbl">âš¡ Impulse Buy</span>
      </div>
      <button class="submit-btn" onclick="addExpense()">+ Log Expense Â· Ctrl+Enter</button>
      <div class="divider"></div>
      <div class="slabel">Monthly Report</div>
      <div class="fg"><label class="lbl">Your Email</label><input type="email" id="inp-email" placeholder="you@gmail.com"></div>
      <button class="email-btn" onclick="showReport()">ğŸ“§ Preview & Email Report</button>
    </aside>

    <main class="main">
      <div class="warn-banner" id="warnBanner">âš ï¸ <span id="warnText"></span></div>

      <!-- Salary bar -->
      <div class="salary-bar" id="salaryBar">
        <div class="salary-top">
          <div class="salary-title" id="salTitle">ğŸ’° Salary Overview</div>
          <div class="salary-meta" id="salMeta"></div>
        </div>
        <div class="salary-track"><div class="salary-fill" id="salFill"></div></div>
        <div class="salary-labels" id="salLabels"></div>
      </div>

      <div class="stats-row">
        <div class="stat-card sc-total"><div class="slbl">Month Total</div><div class="sval" id="stat-total">â‚¹0</div><div class="ssub" id="stat-split">â€”</div></div>
        <div class="stat-card sc-count"><div class="slbl">Transactions</div><div class="sval" id="stat-count">0</div><div class="ssub" id="stat-imp-c">0 impulse</div></div>
        <div class="stat-card sc-stupid"><div class="slbl">Stupid Spends</div><div class="sval" id="stat-stupid">â‚¹0</div><div class="ssub" id="stat-stupid-c">0 txns</div></div>
        <div class="stat-card sc-top"><div class="slbl">Top Category</div><div class="sval" id="stat-top" style="font-size:.95rem;padding-top:5px;">â€”</div><div class="ssub" id="stat-top-amt">â‚¹0</div></div>
      </div>

      <div class="card">
        <div class="card-title">ğŸ“Š Category Breakdown</div>
        <div id="breakdown-bars"><div class="empty-state" style="padding:12px"><div class="empty-icon">ğŸ“‚</div><div class="empty-text">No expenses yet</div></div></div>
      </div>

      <div class="card">
        <div class="list-header">
          <div style="font-size:.8rem;font-weight:700;">ğŸ“‹ Expense Log</div>
          <div class="filter-tabs">
            <button class="ftab active" onclick="setFilter('all',this)">All</button>
            <button class="ftab" onclick="setFilter('valid',this)">âœ… Valid</button>
            <button class="ftab" onclick="setFilter('stupid',this)">ğŸ¤¦ Stupid</button>
            <button class="ftab" onclick="setFilter('impulse',this)">âš¡ Impulse</button>
            <button class="ftab" onclick="setFilter('transfer',this)">ğŸ”„ Transfer</button>
          </div>
        </div>
        <div id="expense-list"><div class="empty-state"><div class="empty-icon">ğŸ§¾</div><div class="empty-text">Start logging</div></div></div>
      </div>
    </main>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â• CHARTS â•â•â•â•â•â•â•â• -->
<div id="tab-charts" class="tab-panel">
  <div class="charts-layout">
    <div class="chart-card">
      <div class="chart-title">ğŸ© By Category</div>
      <div class="donut-wrap">
        <canvas id="donutCanvas" width="148" height="148"></canvas>
        <div class="donut-legend" id="donutLegend"><div class="empty-text" style="color:var(--muted)">No data</div></div>
      </div>
    </div>
    <div class="chart-card">
      <div class="chart-title">âœ… Valid vs ğŸ¤¦ Stupid</div>
      <div class="vs-bar-wrap" id="vsBars"><div class="empty-text" style="color:var(--muted)">No data</div></div>
      <div style="margin-top:12px;font-size:.68rem;color:var(--muted);font-family:'Space Mono',monospace" id="vsRatio">â€”</div>
    </div>
    <div class="chart-card wide">
      <div class="chart-title">ğŸ“… Daily Spending â€” <span id="chartMonthLbl" style="color:var(--accent)">â€”</span></div>
      <div class="daily-bars" id="dailyBars"><div class="empty-state" style="padding:12px"><div class="empty-text">No data</div></div></div>
    </div>
    <div class="chart-card">
      <div class="chart-title">âš¡ Impulse vs Planned</div>
      <div class="donut-wrap">
        <canvas id="impulseDonut" width="148" height="148"></canvas>
        <div class="donut-legend" id="impulseLegend"><div class="empty-text" style="color:var(--muted)">No data</div></div>
      </div>
    </div>
    <div class="chart-card">
      <div class="chart-title">ğŸª Top Merchants</div>
      <div id="merchantBars"><div class="empty-text" style="color:var(--muted)">No data</div></div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â• IMPORT â•â•â•â•â•â•â•â• -->
<div id="tab-import" class="tab-panel">
  <div class="import-layout">
    <div>
      <div class="import-title">ğŸ“¥ Bulk Import</div>
      <div class="import-sub">Paste your raw expense notes. The parser reads your natural writing style â€” section headers, amounts, comments after --, transfers, everything. Review every row before confirming.</div>
    </div>
    <div class="import-box">
      <div class="import-controls">
        <div class="import-date-wrap">
          <div class="import-date-lbl">ğŸ“… Default date (fallback if no date in text)</div>
          <input type="date" class="import-date-inp" id="import-date">
        </div>
      </div>
      <textarea class="import-textarea" id="import-textarea" placeholder="Paste your expense notes hereâ€¦&#10;&#10;Stupid Expenses :-&#10;      Efootball :- â‚¹50, â‚¹440, â‚¹110&#10;-- These were completely unnecessary&#10;Party :-&#10;      Home Food :- â‚¹995&#10;Zomato :- â‚¹84, â‚¹145&#10;-- Stop forgetting your lunch box&#10;Billed till 19/02/2026"></textarea>
      <button class="import-parse-btn" onclick="parseImport()">ğŸ” Parse & Preview</button>
    </div>
    <div>
      <div class="example-lbl">What gets parsed</div>
      <div class="example-card"><span class="hl">Merchant :- â‚¹50, â‚¹440</span>           â†’ 2 entries split by amount
<span class="hl">Stupid Expenses :-</span>               â†’ section; nested items auto-flagged Stupid
<span class="hl">-- This was unnecessary</span>           â†’ comment attached to entry above it
<span class="hl">Transferred to friend :- â‚¹500</span>    â†’ Outflow (money leaving account)
<span class="hl">To ME :- â‚¹737</span>                    â†’ Also Outflow (still leaves salary acc)
<span class="hl">Billed till 19/02/2026</span>           â†’ date auto-extracted for all entries</div>
    </div>
    <div class="preview-box" id="previewBox" style="display:none">
      <div class="preview-header">
        <div><div class="preview-title">Review Parsed Entries</div><div class="preview-count" id="previewCount">â€”</div></div>
        <div class="preview-actions">
          <button class="prev-cancel" onclick="cancelImport()">âœ• Discard</button>
          <button class="prev-confirm" onclick="confirmImport()">âœ… Import All</button>
        </div>
      </div>
      <div style="overflow-x:auto">
        <table class="preview-table">
          <thead><tr><th>Date</th><th>Merchant</th><th>Category</th><th>Amount â‚¹</th><th>Comment</th><th>Type</th><th></th></tr></thead>
          <tbody id="previewBody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

</div><!-- /.app -->

<!-- â”€â”€ ACCOUNTS MODAL â”€â”€ -->
<div class="acc-modal-overlay" id="accModalOverlay">
  <div class="acc-modal">
    <div class="acc-modal-title">ğŸ’³ Accounts & Salary <button class="modal-close" onclick="closeAccModal()">âœ•</button></div>

    <!-- Salary settings for current account -->
    <div class="salary-settings">
      <div class="sal-set-title">ğŸ’° Salary Settings â€” <span id="salSetAccName" style="color:var(--accent)">â€”</span></div>
      <div class="sal-row">
        <div class="fg"><label class="lbl">Default monthly salary (â‚¹)</label><input type="number" id="sal-default" placeholder="19800"></div>
        <button class="submit-btn" style="width:auto;padding:8px 14px;font-size:.78rem;margin-bottom:0;align-self:flex-end" onclick="saveSalary()">Save</button>
      </div>
      <div style="margin-top:8px;font-size:.7rem;color:var(--muted);">You'll be prompted to confirm each month's actual salary whenever it hasn't been entered. Past entries are listed below.</div>
      <div class="sal-override-list" id="salOverrideList"></div>
    </div>

    <!-- Account list -->
    <div class="acc-list" id="accList"></div>

    <!-- Add new account -->
    <div class="acc-add-form">
      <div class="acc-add-title">+ Add Account</div>
      <div class="acc-add-row">
        <input type="text" id="new-acc-name" placeholder="Account name (e.g. Primary, Salary)">
      </div>
      <div class="color-picker-row" id="colorPicker"></div>
      <button class="submit-btn" onclick="addAccount()">Add Account</button>
    </div>
  </div>
</div>

<!-- â”€â”€ SALARY PROMPT MODAL â”€â”€ -->
<div class="modal-overlay" id="salaryPromptModal">
  <div class="modal">
    <div class="modal-title">ğŸ’° Enter This Month's Salary <button class="modal-close" onclick="closeModal('salaryPromptModal')">âœ•</button></div>
    <div style="font-size:.78rem;color:var(--muted);margin-bottom:14px;" id="salPromptSubtitle">â€”</div>
    <div class="fg">
      <label class="lbl">Salary received this month (â‚¹)</label>
      <input type="number" id="sal-prompt-amt" placeholder="e.g. 19800" style="font-size:1rem;padding:12px;">
    </div>
    <div style="font-size:.7rem;color:var(--muted);margin-bottom:14px;">This will only be saved for <span id="salPromptMonth" style="color:var(--accent);font-weight:700;">â€”</span>. Next month you'll be prompted again.</div>
    <div class="modal-actions">
      <button class="modal-btn secondary" onclick="closeModal('salaryPromptModal')">Later</button>
      <button class="modal-btn primary" onclick="saveSalaryPrompt()">Save</button>
    </div>
  </div>
</div>

<!-- â”€â”€ REPORT MODAL â”€â”€ -->
<div class="modal-overlay" id="reportModal">
  <div class="modal">
    <div class="modal-title">ğŸ“§ Report Preview <button class="modal-close" onclick="closeModal('reportModal')">âœ•</button></div>
    <div class="report-preview" id="reportPreview"></div>
    <div class="modal-actions">
      <button class="modal-btn secondary" onclick="copyReport()">ğŸ“‹ Copy</button>
      <button class="modal-btn primary" onclick="sendEmailReport()">Send via Email</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONSTANTS & STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SK = 'paisawatch_v3';
const SK_CONFIG = 'paisawatch_fbconfig';
const MONTHS = ['January','February','March','April','May','June','July','August','September','October','November','December'];

const CAT_META = {
  Food:          {icon:'ğŸ”',color:'food',         hex:'#ff6b35'},
  Groceries:     {icon:'ğŸ›’',color:'groceries',    hex:'#22d3ee'},
  Entertainment: {icon:'ğŸ®',color:'entertainment',hex:'#a855f7'},
  Party:         {icon:'ğŸ‰',color:'party',        hex:'#f59e0b'},
  Gifts:         {icon:'ğŸ',color:'gifts',        hex:'#ec4899'},
  Transport:     {icon:'ğŸšŒ',color:'transport',    hex:'#3b82f6'},
  Impulse:       {icon:'âš¡',color:'impulse',      hex:'#ef4444'},
  Transfer:      {icon:'ğŸ”„',color:'transfer',     hex:'#38bdf8'},
  Other:         {icon:'ğŸ“¦',color:'other',        hex:'#6b7280'},
};

const ACC_COLORS = ['#e8ff47','#ff6b35','#a855f7','#22d3ee','#ec4899','#3b82f6','#f59e0b','#47ff8a'];

function defaultState() {
  return {
    accounts: [
      { id:'salary', name:'Salary Acc', color:'#e8ff47', salary:19800, salaryOverrides:{}, isDefault:true },
      { id:'primary', name:'Primary Acc', color:'#22d3ee', salary:0, salaryOverrides:{}, isDefault:false },
    ],
    activeAccountId: 'salary',
    expenses: [],
  };
}

let STATE = JSON.parse(localStorage.getItem(SK) || 'null') || defaultState();
if (!STATE.accounts) STATE = defaultState();

let currentUser  = null;   // Firebase user object
let useFirestore = false;  // true once Firebase + auth is confirmed
let saveTimer    = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AUTH SCREEN LOGIC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showAuthScreen(card) {
  document.getElementById('authScreen').classList.remove('hidden');
  document.getElementById('mainApp').style.display = 'none';
  document.getElementById('authLoading').style.display  = 'none';
  document.getElementById('loginCard').style.display    = 'none';
  document.getElementById('setupCard').style.display    = 'none';
  if (card) document.getElementById(card).style.display = 'block';
}

function showMainApp(user) {
  document.getElementById('authScreen').classList.add('hidden');
  document.getElementById('mainApp').style.display = 'block';

  if (user) {
    currentUser = user;
    useFirestore = true;
    const pill = document.getElementById('userPill');
    pill.style.display = 'flex';
    document.getElementById('userName').textContent = user.displayName?.split(' ')[0] || user.email;
    document.getElementById('userMenuEmail').textContent = user.email;

    // Avatar
    if (user.photoURL) {
      const img = document.createElement('img');
      img.src = user.photoURL; img.className = 'user-avatar';
      document.getElementById('userAvatar').replaceWith(img);
      img.id = 'userAvatar';
    } else {
      document.getElementById('userAvatar').textContent = (user.displayName||user.email||'?')[0].toUpperCase();
    }
  }
}

function toggleUserMenu() {
  const m = document.getElementById('userMenu');
  m.style.display = m.style.display === 'none' ? 'block' : 'none';
}
document.addEventListener('click', e => {
  if (!e.target.closest('#userPill') && !e.target.closest('#userMenu')) {
    document.getElementById('userMenu').style.display = 'none';
  }
});

let authInProgress = false;

function doSignIn() {
  if (!window.__FB__ || authInProgress) return;
  authInProgress = true;
  const btn = document.querySelector('.google-btn');
  if (btn) { btn.textContent = 'Redirecting to Googleâ€¦'; btn.disabled = true; }
  window.__FB__.signIn().catch(err => {
    authInProgress = false;
    if (btn) { btn.textContent = 'Continue with Google'; btn.disabled = false; }
    toast('Sign-in failed: ' + (err.message || err.code), true);
  });
}

function doSignOut() {
  if (!window.__FB__) return;
  window.__FB__.signOut().then(() => {
    currentUser = null; useFirestore = false;
    document.getElementById('userMenu').style.display = 'none';
    document.getElementById('userPill').style.display = 'none';
    showAuthScreen('loginCard');
  });
}

// Config setup
function applyConfig() {
  const raw = document.getElementById('configInput').value.trim();
  try {
    // Accept the firebaseConfig object â€” strip any surrounding variable assignment if pasted
    let cleaned = raw
      .replace(/^.*?=\s*/, '')   // strip "const firebaseConfig = "
      .replace(/;?\s*$/, '')     // strip trailing semicolon
      .trim();
    // Fix unquoted keys like  apiKey: "..."  â†’ "apiKey": "..."
    cleaned = cleaned.replace(/([{,]\s*)([a-zA-Z_]\w*)(\s*:)/g, '$1"$2"$3');
    const cfg = JSON.parse(cleaned);
    if (!cfg.apiKey || !cfg.projectId) throw new Error('Missing required fields');
    localStorage.setItem(SK_CONFIG, JSON.stringify(cfg));
    toast('âœ… Config saved! Reloadingâ€¦');
    setTimeout(() => location.reload(), 1000);
  } catch(e) {
    toast('Invalid config â€” paste the full { apiKey: "...", ... } object', true);
  }
}

function skipToLocal() {
  showMainApp(null);
  init();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SAVE â€” debounced, Firestore or localStorage
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function save() {
  localStorage.setItem(SK, JSON.stringify(STATE)); // always keep local copy
  if (!useFirestore || !currentUser) return;

  // Show saving indicator
  const dot = document.getElementById('savingDot');
  dot.classList.add('active');

  clearTimeout(saveTimer);
  saveTimer = setTimeout(async () => {
    try {
      await window.__FB__.saveData(currentUser.uid, STATE);
    } catch(e) {
      console.error('Firestore save error:', e);
      toast('âš ï¸ Cloud save failed â€” data is safe locally', true);
    } finally {
      dot.classList.remove('active');
    }
  }, 800); // debounce 800ms so rapid changes batch together
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FIREBASE ENTRY POINT â€” callback pattern, avoids event race
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function onFirebaseReady() {
  const fb = window.__FB__;

  if (!fb) {
    const savedCfg = localStorage.getItem(SK_CONFIG);
    if (savedCfg) {
      showAuthScreen('loginCard');
      toast('âš ï¸ Could not reach Firebase. Check your connection.', true);
      return;
    }
    showAuthScreen('setupCard');
    return;
  }

  // Keep showing "Loadingâ€¦" while we check redirect result first
  // This prevents the login screen flashing before auth resolves
  fb.getRedirectResult()
    .then(result => {
      if (result && result.user) {
        // Came back from Google redirect â€” user is now signed in
        // onAuthStateChanged will fire next with this user
      }
    })
    .catch(err => {
      console.warn('Redirect result error (usually safe to ignore):', err.code);
    })
    .finally(() => {
      // NOW safe to start listening â€” redirect result is fully settled
      let authResolved = false;
      fb.onAuth(async (user) => {
        if (authResolved) {
          // Subsequent auth changes (e.g. sign out)
          if (!user) showAuthScreen('loginCard');
          return;
        }
        authResolved = true;

        if (user) {
          try {
            const cloudState = await fb.loadData(user.uid);
            if (cloudState) {
              STATE = cloudState;
              if (!STATE.accounts) STATE = defaultState();
              localStorage.setItem(SK, JSON.stringify(STATE));
            }
          } catch(e) {
            console.error('Firestore load error:', e);
            toast('âš ï¸ Could not load cloud data, using local copy', true);
          }
          showMainApp(user);
          init();
        } else {
          showAuthScreen('loginCard');
        }
      });
    });
}

// Register callback â€” if module already fired, call immediately; otherwise wait
window.__onFirebaseReady__ = onFirebaseReady;
if (window.__FB_READY__) {
  onFirebaseReady();
} else {
  // Fallback: if module never fires (e.g. blocked, CSP issue), show setup after 8s
  setTimeout(() => {
    if (!window.__FB_READY__) {
      console.warn('Firebase module did not load in time');
      window.__FB_READY__ = true;
      onFirebaseReady();
    }
  }, 8000);
}

// â”€â”€ App state variables â”€â”€
let expenseType = 'valid';
let isImpulse   = false;
let currentFilter = 'all';
let viewYear, viewMonth;
let activeTab = 'dashboard';
let reportText = '';
let parsedRows = [];
let selectedNewAccColor = ACC_COLORS[0];

function esc(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function toDS(d) { return d.toISOString().split('T')[0]; }
function activeAcc() { return STATE.accounts.find(a=>a.id===STATE.activeAccountId) || STATE.accounts[0]; }
function monthKey() { return `${viewYear}-${String(viewMonth+1).padStart(2,'0')}`; }
function monthExpenses() {
  return STATE.expenses.filter(e => {
    if (e.accountId !== STATE.activeAccountId) return false;
    const d = new Date(e.date+'T00:00:00');
    return d.getFullYear()===viewYear && d.getMonth()===viewMonth;
  });
}
function getSalary(acc) {
  const mk = monthKey();
  return acc.salaryOverrides?.[mk] ?? acc.salary ?? 0;
}

let toastTimer;
function toast(msg,err=false){
  const el=document.getElementById('toast'); el.textContent=msg;
  el.className='toast show'+(err?' error':'');
  clearTimeout(toastTimer); toastTimer=setTimeout(()=>el.classList.remove('show'),3000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function init() {
  const now = new Date();
  viewYear = now.getFullYear(); viewMonth = now.getMonth();
  document.getElementById('inp-date').value = toDS(now);
  document.getElementById('headerDate').textContent =
    now.toLocaleDateString('en-IN',{weekday:'long',day:'numeric',month:'long',year:'numeric'});
  document.getElementById('import-date').value = toDS(now);
  updateDateHint();
  updateHeaderAcc();
  render();

  // Prompt for this month's salary if not yet set (salary account only)
  const acc = activeAcc();
  if (acc.id === 'salary') {
    const mk = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
    const alreadySet = acc.salaryOverrides?.[mk];
    if (!alreadySet) {
      setTimeout(openSalaryPrompt, 600);
    }
  }
}

function updateHeaderAcc() {
  const acc = activeAcc();
  document.getElementById('hdr-acc-dot').style.background = acc.color;
  document.getElementById('hdr-acc-name').textContent = acc.name;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MONTH NAV
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function changeMonth(d) {
  viewMonth += d;
  if (viewMonth > 11) { viewMonth=0; viewYear++; }
  if (viewMonth < 0)  { viewMonth=11; viewYear--; }
  render();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(tab, btn) {
  activeTab = tab;
  document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.main-tab').forEach(b=>b.classList.remove('active'));
  document.getElementById('tab-'+tab).classList.add('active');
  btn.classList.add('active');
  if (tab==='charts') renderCharts(monthExpenses());
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DATE FIELD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setToday() { document.getElementById('inp-date').value=toDS(new Date()); updateDateHint(); }
function updateDateHint() {
  const val = document.getElementById('inp-date').value;
  const el  = document.getElementById('dateHint');
  if (!val) { el.textContent=''; return; }
  const d=new Date(val+'T00:00:00'), today=new Date(); today.setHours(0,0,0,0);
  const diff=Math.round((today-d)/86400000);
  if (diff===0) el.textContent='ğŸ“ Today';
  else if (diff===1) el.textContent='ğŸ“ Yesterday';
  else if (diff>1) el.textContent=`ğŸ“ ${diff} days ago â€” backdated âœ“`;
  else el.textContent='ğŸ“ Future date';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FORM STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setType(t) {
  expenseType = t;
  document.getElementById('type-valid').className  = 'type-btn'+(t==='valid'?' valid-active':'');
  document.getElementById('type-stupid').className = 'type-btn'+(t==='stupid'?' stupid-active':'');
}
function toggleImpulse() {
  isImpulse = !isImpulse;
  document.getElementById('impulseTog').classList.toggle('active',isImpulse);
  document.getElementById('impChk').textContent = isImpulse?'âœ“':'';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ADD EXPENSE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addExpense() {
  const date     = document.getElementById('inp-date').value;
  const category = document.getElementById('inp-category').value;
  const merchant = document.getElementById('inp-merchant').value.trim();
  const amount   = parseFloat(document.getElementById('inp-amount').value);
  const note     = document.getElementById('inp-note').value.trim();
  if (!date)           return toast('ğŸ“… Pick a date',true);
  if (!merchant)       return toast('ğŸª Enter merchant',true);
  if (!amount||amount<=0) return toast('ğŸ’° Enter amount',true);

  // Determine transfer direction
  let transferDir = null;
  if (category==='Transfer') transferDir = 'out';

  STATE.expenses.push({
    id: Date.now()+Math.random(),
    accountId: STATE.activeAccountId,
    date, category, merchant, amount, note,
    type: category==='Transfer' ? 'transfer' : expenseType,
    isImpulse: isImpulse || category==='Impulse',
    transferDir,
  });
  save();

  document.getElementById('inp-merchant').value='';
  document.getElementById('inp-amount').value='';
  document.getElementById('inp-note').value='';
  setType('valid');
  if (isImpulse) toggleImpulse();

  const d=new Date(date+'T00:00:00'); viewYear=d.getFullYear(); viewMonth=d.getMonth();
  toast('âœ… Logged!'); render();
}

function deleteExpense(id) {
  STATE.expenses = STATE.expenses.filter(e=>e.id!==id);
  save(); render(); toast('ğŸ—‘ï¸ Deleted');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FILTER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setFilter(f,el) {
  currentFilter=f;
  document.querySelectorAll('.ftab').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');
  renderList(monthExpenses());
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render() {
  document.getElementById('monthLabel').textContent      = MONTHS[viewMonth]+' '+viewYear;
  document.getElementById('chartMonthLbl').textContent   = MONTHS[viewMonth]+' '+viewYear;
  const data = monthExpenses();
  renderSalaryBar(data);
  renderStats(data);
  renderBreakdown(data);
  renderList(data);
  renderWarning(data);
  if (activeTab==='charts') renderCharts(data);
}

function renderSalaryBar(data) {
  const acc     = activeAcc();
  const salary  = getSalary(acc);
  const bar     = document.getElementById('salaryBar');

  // Only show for salary account
  if (acc.id !== 'salary') { bar.style.display='none'; return; }
  bar.style.display='block';

  // If no salary set for this month, show prompt instead
  if (!salary) {
    document.getElementById('salTitle').textContent = `ğŸ’° ${acc.name} â€” ${MONTHS[viewMonth]} ${viewYear}`;
    document.getElementById('salMeta').innerHTML = `<span style="font-size:.75rem;color:var(--muted)">Salary not set for this month.</span>
      <button onclick="openSalaryPrompt()" style="background:var(--accent);border:none;border-radius:6px;color:#000;cursor:pointer;font-family:'Syne',sans-serif;font-size:.72rem;font-weight:800;padding:4px 12px;margin-left:8px;">Enter Salary</button>`;
    document.getElementById('salFill').style.width='0%';
    document.getElementById('salLabels').innerHTML='';
    return;
  }

  const expenses    = data.filter(e=>e.type!=='transfer').reduce((s,e)=>s+e.amount,0);
  const transferOut = data.filter(e=>e.type==='transfer').reduce((s,e)=>s+e.amount,0);
  const totalSpent  = expenses + transferOut;
  const remaining   = salary - totalSpent;
  const pct         = Math.min(totalSpent/salary*100,100);
  const isOver      = totalSpent > salary;

  const fill = document.getElementById('salFill');
  fill.style.width = pct+'%';
  fill.style.background = isOver ? '#ff4444' : pct>80 ? '#f59e0b' : '#47ff8a';

  document.getElementById('salTitle').textContent = `ğŸ’° ${acc.name} â€” ${MONTHS[viewMonth]} ${viewYear}`;
  document.getElementById('salMeta').innerHTML = `
    <span><span class="sm-lbl">Salary</span><span class="sm-val" style="color:var(--salary-clr)">â‚¹${salary.toLocaleString('en-IN')}</span></span>
    <span><span class="sm-lbl">Spent</span><span class="sm-val" style="color:var(--a2)">â‚¹${expenses.toFixed(0)}</span></span>
    <span><span class="sm-lbl">Outflow</span><span class="sm-val" style="color:var(--transfer-clr)">â‚¹${transferOut.toFixed(0)}</span></span>
    <span><span class="sm-lbl">Remaining</span><span class="sm-val" style="color:${isOver?'var(--danger)':'var(--valid)'}">â‚¹${remaining.toFixed(0)}</span></span>
  `;
  document.getElementById('salLabels').innerHTML = `<span>â‚¹0</span><span style="color:${isOver?'var(--danger)':'var(--muted)'}">${pct.toFixed(1)}% used</span><span>â‚¹${salary.toLocaleString('en-IN')}</span>`;
}

function renderStats(data) {
  const expenses = data.filter(e=>e.type!=='transfer');
  const total    = expenses.reduce((s,e)=>s+e.amount,0);
  const stupidT  = expenses.filter(e=>e.type==='stupid').reduce((s,e)=>s+e.amount,0);
  const validT   = total-stupidT;
  const impulse  = expenses.filter(e=>e.isImpulse).length;
  const catTots  = {}; expenses.forEach(e=>{catTots[e.category]=(catTots[e.category]||0)+e.amount;});
  const top      = Object.entries(catTots).sort((a,b)=>b[1]-a[1])[0];

  document.getElementById('stat-total').textContent = 'â‚¹'+total.toFixed(0);
  document.getElementById('stat-split').textContent = total>0?`${(validT/total*100).toFixed(0)}% valid Â· ${(stupidT/total*100).toFixed(0)}% stupid`:'â€”';
  document.getElementById('stat-count').textContent = expenses.length;
  document.getElementById('stat-imp-c').textContent = impulse+' impulse'+(impulse!==1?'s':'');
  document.getElementById('stat-stupid').textContent = 'â‚¹'+stupidT.toFixed(0);
  document.getElementById('stat-stupid-c').textContent = expenses.filter(e=>e.type==='stupid').length+' txn'+(expenses.filter(e=>e.type==='stupid').length!==1?'s':'');
  document.getElementById('stat-top').textContent = top?top[0]:'â€”';
  document.getElementById('stat-top-amt').textContent = top?'â‚¹'+top[1].toFixed(0):'â‚¹0';
}

function renderBreakdown(data) {
  const el = document.getElementById('breakdown-bars');
  const expenses = data.filter(e=>e.type!=='transfer');
  if (!expenses.length) { el.innerHTML='<div class="empty-state" style="padding:12px"><div class="empty-icon">ğŸ“‚</div><div class="empty-text">No expenses</div></div>'; return; }
  const tots={}; expenses.forEach(e=>{tots[e.category]=(tots[e.category]||0)+e.amount;});
  const max=Math.max(...Object.values(tots));
  el.innerHTML=Object.entries(tots).sort((a,b)=>b[1]-a[1]).map(([cat,tot])=>{
    const m=CAT_META[cat]||{icon:'ğŸ“¦',color:'other'};
    return `<div class="cat-bar-row"><div class="cat-name c-${m.color}">${m.icon} ${cat}</div><div class="cat-bar-track"><div class="cat-bar-fill bar-${m.color}" style="width:${(tot/max*100).toFixed(1)}%"></div></div><div class="cat-amount c-${m.color}">â‚¹${tot.toFixed(0)}</div></div>`;
  }).join('');
}

function renderList(data) {
  const el = document.getElementById('expense-list');
  let f=data;
  if (currentFilter==='valid')    f=data.filter(e=>e.type==='valid');
  if (currentFilter==='stupid')   f=data.filter(e=>e.type==='stupid');
  if (currentFilter==='impulse')  f=data.filter(e=>e.isImpulse);
  if (currentFilter==='transfer') f=data.filter(e=>e.type==='transfer');
  const sorted=[...f].sort((a,b)=>new Date(b.date)-new Date(a.date));
  if (!sorted.length){el.innerHTML='<div class="empty-state"><div class="empty-icon">ğŸ§¾</div><div class="empty-text">No entries match</div></div>';return;}
  el.innerHTML=sorted.map(e=>{
    const m=CAT_META[e.category]||{icon:'ğŸ“¦',color:'other'};
    const ds=new Date(e.date+'T00:00:00').toLocaleDateString('en-IN',{day:'numeric',month:'short'});
    let typeBadge='';
    if (e.type==='transfer') typeBadge=`<span class="badge transfer-out">â†— Outflow</span>`;
    else typeBadge=`<span class="badge ${e.type}">${e.type==='valid'?'âœ… Valid':'ğŸ¤¦ Stupid'}</span>`;
    const impBadge=e.isImpulse?'<span class="badge impulse">âš¡ Impulse</span>':'';
    const commentEl=e.note?`<div class="exp-comment">${esc(e.note)}</div>`:'';
    const amtColor=e.type==='transfer'?'var(--transfer-clr)':`var(--${m.color==='other'?'other':m.color})`;
    return `<div class="expense-item">
      <div class="cat-pill bg-${m.color}">${m.icon}</div>
      <div class="exp-info">
        <div class="exp-merchant">${esc(e.merchant)}</div>
        <div class="exp-meta"><span>${ds}</span><span class="c-${m.color}">${e.category}</span></div>
        ${commentEl}
        <div class="exp-badges">${typeBadge}${impBadge}</div>
      </div>
      <div class="exp-amount" style="color:${amtColor}">â‚¹${e.amount.toFixed(0)}</div>
      <button class="del-btn" onclick="deleteExpense(${e.id})" title="Delete">âœ•</button>
    </div>`;
  }).join('');
}

function renderWarning(data) {
  const banner=document.getElementById('warnBanner');
  const expenses=data.filter(e=>e.type!=='transfer');
  const impulse=expenses.filter(e=>e.isImpulse);
  const stupid =expenses.filter(e=>e.type==='stupid');
  const zomato =expenses.filter(e=>e.merchant.toLowerCase().includes('zomato'));
  const w=[];
  if (impulse.length>=3) w.push(`âš¡ ${impulse.length} impulse buys`);
  if (stupid.length>=2)  w.push(`ğŸ¤¦ â‚¹${stupid.reduce((s,e)=>s+e.amount,0).toFixed(0)} wasted`);
  if (zomato.length>=3)  w.push(`ğŸ• Zomato ${zomato.length}Ã— â€” pack lunch!`);
  const acc=activeAcc(); const salary=getSalary(acc);
  if (salary>0 && acc.id==='salary') {
    const totalOut=expenses.reduce((s,e)=>s+e.amount,0)+data.filter(e=>e.type==='transfer').reduce((s,e)=>s+e.amount,0);
    if (totalOut>salary*0.9) w.push(`ğŸš¨ Over 90% of salary used!`);
  }
  if (w.length){document.getElementById('warnText').textContent=w.join(' Â· ');banner.classList.add('show');}
  else banner.classList.remove('show');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ACCOUNTS MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openAccModal() {
  renderAccModal();
  document.getElementById('accModalOverlay').classList.add('show');
}
function closeAccModal() { document.getElementById('accModalOverlay').classList.remove('show'); }
function closeModal(id) { document.getElementById(id).classList.remove('show'); }

function renderAccModal() {
  const acc = activeAcc();
  document.getElementById('salSetAccName').textContent = acc.name;
  document.getElementById('sal-default').value = acc.salary||'';

  // Show past salary entries (from prompt saves)
  const ol = document.getElementById('salOverrideList');
  const overrides = acc.salaryOverrides||{};
  ol.innerHTML = Object.entries(overrides).length
    ? Object.entries(overrides).sort().map(([mk,amt])=>`
        <div class="sal-override-item">
          <span>${mk}</span>
          <span style="color:var(--salary-clr)">â‚¹${amt.toLocaleString('en-IN')}</span>
          <button class="sal-del" onclick="delSalaryOverride('${mk}')">âœ•</button>
        </div>`).join('')
    : '<div style="font-size:.72rem;color:var(--muted)">No monthly salaries recorded yet</div>';

  // Account list
  const al = document.getElementById('accList');
  al.innerHTML = STATE.accounts.map(a=>`
    <div class="acc-item ${a.id===STATE.activeAccountId?'active-acc':''}" onclick="switchAccount('${a.id}')">
      <div class="acc-item-dot" style="background:${a.color}"></div>
      <div class="acc-item-info">
        <div class="acc-item-name">${esc(a.name)}</div>
        <div class="acc-item-meta">Salary: ${a.salary?'â‚¹'+a.salary.toLocaleString('en-IN'):'Not set'} Â· ${STATE.expenses.filter(e=>e.accountId===a.id).length} transactions</div>
      </div>
      ${a.id===STATE.activeAccountId?'<span class="acc-item-check">â—</span>':''}
    </div>`).join('');

  // Color picker
  const cp = document.getElementById('colorPicker');
  cp.innerHTML = ACC_COLORS.map(c=>`<div class="color-dot-pick ${c===selectedNewAccColor?'selected':''}" style="background:${c}" onclick="selectColor('${c}')"></div>`).join('');
}

function selectColor(c) {
  selectedNewAccColor = c;
  document.querySelectorAll('.color-dot-pick').forEach(el=>{
    el.classList.toggle('selected', el.style.background===c||el.style.backgroundColor===c);
  });
}

function saveSalary() {
  const acc = activeAcc();
  const val = parseFloat(document.getElementById('sal-default').value)||0;
  acc.salary = val;
  save(); renderAccModal(); render();
  toast('ğŸ’° Salary saved!');
}

function openSalaryPrompt() {
  const mk = monthKey();
  const label = MONTHS[viewMonth]+' '+viewYear;
  document.getElementById('salPromptSubtitle').textContent = `What salary did you receive for ${label}?`;
  document.getElementById('salPromptMonth').textContent = label;
  // Pre-fill with default if available
  const acc = activeAcc();
  document.getElementById('sal-prompt-amt').value = acc.salaryOverrides?.[mk] || acc.salary || '';
  document.getElementById('salaryPromptModal').classList.add('show');
}

function saveSalaryPrompt() {
  const amt = parseFloat(document.getElementById('sal-prompt-amt').value)||0;
  if (!amt) return toast('Enter a valid amount',true);
  const acc = activeAcc();
  const mk  = monthKey();
  if (!acc.salaryOverrides) acc.salaryOverrides={};
  acc.salaryOverrides[mk] = amt;
  save();
  closeModal('salaryPromptModal');
  render();
  toast(`ğŸ’° Salary for ${MONTHS[viewMonth]} saved: â‚¹${amt.toLocaleString('en-IN')}`);
}

function delSalaryOverride(mk) {
  const acc=activeAcc();
  delete acc.salaryOverrides[mk];
  save(); renderAccModal(); render();
}

function switchAccount(id) {
  STATE.activeAccountId = id;
  save(); updateHeaderAcc(); renderAccModal(); render();
  toast('Switched to '+activeAcc().name);
}

function addAccount() {
  const name = document.getElementById('new-acc-name').value.trim();
  if (!name) return toast('Enter account name',true);
  const id = 'acc_'+Date.now();
  STATE.accounts.push({ id, name, color:selectedNewAccColor, salary:0, salaryOverrides:{} });
  document.getElementById('new-acc-name').value='';
  save(); renderAccModal();
  toast('âœ… Account added: '+name);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CHARTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderCharts(data) {
  document.getElementById('chartMonthLbl').textContent = MONTHS[viewMonth]+' '+viewYear;
  const expenses = data.filter(e=>e.type!=='transfer');
  renderCatDonut(expenses);
  renderVsChart(expenses);
  renderDailyBars(data);
  renderImpulseDonut(expenses);
  renderMerchantBars(expenses);
}

function drawDonut(id,segs) {
  const c=document.getElementById(id),ctx=c.getContext('2d');
  const W=c.width,H=c.height,cx=W/2,cy=H/2,r=W/2-7,ir=r*.57;
  ctx.clearRect(0,0,W,H);
  const total=segs.reduce((s,g)=>s+g.value,0);
  if (!total){ctx.fillStyle='#2a2a2a';ctx.beginPath();ctx.arc(cx,cy,r,0,Math.PI*2);ctx.fill();ctx.fillStyle='#161616';ctx.beginPath();ctx.arc(cx,cy,ir,0,Math.PI*2);ctx.fill();return;}
  let st=-Math.PI/2;
  segs.forEach(g=>{const ang=(g.value/total)*Math.PI*2;ctx.beginPath();ctx.moveTo(cx,cy);ctx.arc(cx,cy,r,st,st+ang);ctx.closePath();ctx.fillStyle=g.color;ctx.fill();st+=ang;});
  ctx.fillStyle='#161616';ctx.beginPath();ctx.arc(cx,cy,ir,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='#f0f0f0';ctx.font='bold 11px Syne';ctx.textAlign='center';ctx.textBaseline='middle';
  ctx.fillText('â‚¹'+Math.round(total),cx,cy);
}

function renderCatDonut(data) {
  const tots={};data.forEach(e=>{tots[e.category]=(tots[e.category]||0)+e.amount;});
  const sorted=Object.entries(tots).sort((a,b)=>b[1]-a[1]);
  const total=data.reduce((s,e)=>s+e.amount,0);
  drawDonut('donutCanvas',sorted.map(([cat,v])=>({color:CAT_META[cat]?.hex||'#6b7280',value:v})));
  const leg=document.getElementById('donutLegend');
  if (!sorted.length){leg.innerHTML='<div class="empty-text" style="color:var(--muted)">No data</div>';return;}
  leg.innerHTML=sorted.map(([cat,v])=>{const hex=CAT_META[cat]?.hex||'#6b7280';return `<div class="legend-item"><div class="legend-dot" style="background:${hex}"></div><span class="legend-label">${cat}</span><span class="legend-val" style="color:${hex}">â‚¹${v.toFixed(0)} <span style="color:var(--muted)">${total>0?(v/total*100).toFixed(1):0}%</span></span></div>`;}).join('');
}

function renderImpulseDonut(data) {
  const iT=data.filter(e=>e.isImpulse).reduce((s,e)=>s+e.amount,0);
  const pT=data.filter(e=>!e.isImpulse).reduce((s,e)=>s+e.amount,0);
  drawDonut('impulseDonut',[{color:'#ff6b35',value:iT},{color:'#47ff8a',value:pT}]);
  const leg=document.getElementById('impulseLegend');
  const tot=iT+pT;
  if (!tot){leg.innerHTML='<div class="empty-text" style="color:var(--muted)">No data</div>';return;}
  leg.innerHTML=`<div class="legend-item"><div class="legend-dot" style="background:#ff6b35"></div><span class="legend-label">Impulse</span><span class="legend-val" style="color:#ff6b35">â‚¹${iT.toFixed(0)} <span style="color:var(--muted)">${(iT/tot*100).toFixed(1)}%</span></span></div><div class="legend-item"><div class="legend-dot" style="background:#47ff8a"></div><span class="legend-label">Planned</span><span class="legend-val" style="color:#47ff8a">â‚¹${pT.toFixed(0)} <span style="color:var(--muted)">${(pT/tot*100).toFixed(1)}%</span></span></div>`;
}

function renderVsChart(data) {
  const vT=data.filter(e=>e.type==='valid').reduce((s,e)=>s+e.amount,0);
  const sT=data.filter(e=>e.type==='stupid').reduce((s,e)=>s+e.amount,0);
  const tot=vT+sT;
  const el=document.getElementById('vsBars'),ratio=document.getElementById('vsRatio');
  if (!tot){el.innerHTML='<div class="empty-text" style="color:var(--muted)">No data</div>';ratio.textContent='â€”';return;}
  const vP=(vT/tot*100).toFixed(1),sP=(sT/tot*100).toFixed(1);
  el.innerHTML=`<div class="vs-row"><div class="vs-lbl" style="color:var(--valid)">âœ… Valid</div><div class="vs-track"><div class="vs-fill vf" style="width:${vP}%"></div></div><div class="vs-amt" style="color:var(--valid)">â‚¹${vT.toFixed(0)}</div></div><div class="vs-row"><div class="vs-lbl" style="color:var(--stupid)">ğŸ¤¦ Stupid</div><div class="vs-track"><div class="vs-fill sf" style="width:${sP}%"></div></div><div class="vs-amt" style="color:var(--stupid)">â‚¹${sT.toFixed(0)}</div></div><div style="margin-top:12px;padding-top:11px;border-top:1px solid var(--border);font-size:.7rem;color:var(--muted)">${data.filter(e=>e.type==='stupid').length} stupid Â· ${data.filter(e=>e.type==='valid').length} valid</div>`;
  ratio.textContent=`${vP}% valid Â· ${sP}% wasted`;
}

function renderDailyBars(data) {
  const el=document.getElementById('dailyBars');
  const days=new Date(viewYear,viewMonth+1,0).getDate();
  const daily={};
  data.forEach(e=>{if(e.type==='transfer')return;const d=parseInt(e.date.split('-')[2]);daily[d]=(daily[d]||0)+e.amount;});
  const vals=Array.from({length:days},(_,i)=>daily[i+1]||0);
  const max=Math.max(...vals,1);
  if (!data.filter(e=>e.type!=='transfer').length){el.innerHTML='<div class="empty-state" style="padding:12px"><div class="empty-text">No data</div></div>';return;}
  el.innerHTML=vals.map((v,i)=>{const day=i+1,h=Math.max(v/max*82,v>0?4:1),col=v>0?(v>max*.7?'#ff4444':v>max*.4?'#f59e0b':'#e8ff47'):'#2a2a2a';return `<div class="daily-col"><div class="daily-bar" style="height:${h}px;background:${col}" data-tip="${MONTHS[viewMonth].slice(0,3)} ${day}: â‚¹${v.toFixed(0)}"></div><div class="daily-day">${day}</div></div>`;}).join('');
}

function renderMerchantBars(data) {
  const el=document.getElementById('merchantBars');
  if (!data.length){el.innerHTML='<div class="empty-text" style="color:var(--muted)">No data</div>';return;}
  const tots={};data.forEach(e=>{tots[e.merchant]=(tots[e.merchant]||0)+e.amount;});
  const sorted=Object.entries(tots).sort((a,b)=>b[1]-a[1]).slice(0,6);
  const max=sorted[0][1];
  el.innerHTML=sorted.map(([mer,val])=>`<div class="cat-bar-row"><div class="cat-name" style="color:var(--text);font-size:.7rem">${esc(mer)}</div><div class="cat-bar-track"><div class="cat-bar-fill" style="width:${(val/max*100).toFixed(1)}%;background:var(--accent)"></div></div><div class="cat-amount" style="color:var(--accent)">â‚¹${val.toFixed(0)}</div></div>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  REPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildReport() {
  const data=monthExpenses(), acc=activeAcc(), salary=getSalary(acc);
  const expenses=data.filter(e=>e.type!=='transfer');
  const total=expenses.reduce((s,e)=>s+e.amount,0);
  const vT=expenses.filter(e=>e.type==='valid').reduce((s,e)=>s+e.amount,0);
  const sT=expenses.filter(e=>e.type==='stupid').reduce((s,e)=>s+e.amount,0);
  const tOut=data.filter(e=>e.type==='transfer').reduce((s,e)=>s+e.amount,0);
  const catT={};expenses.forEach(e=>{catT[e.category]=(catT[e.category]||0)+e.amount;});
  return [
    'PAISA WATCH â€” EXPENSE REPORT',`${MONTHS[viewMonth]} ${viewYear} Â· ${acc.name}`,
    `Generated: ${new Date().toLocaleString('en-IN')}`,'â”€'.repeat(44),'',
    'SUMMARY',
    `Salary:        â‚¹${salary.toLocaleString('en-IN')}`,
    `Total Spent:   â‚¹${total.toFixed(2)}`,
    `Valid Spend:   â‚¹${vT.toFixed(2)}  (${total>0?(vT/total*100).toFixed(1):0}%)`,
    `Stupid Spend:  â‚¹${sT.toFixed(2)}  (${total>0?(sT/total*100).toFixed(1):0}%)`,
    `Outflow:       â‚¹${tOut.toFixed(2)}`,
    `Remaining:     â‚¹${(salary-total-tOut).toFixed(2)}`,
    `Impulse Buys:  ${expenses.filter(e=>e.isImpulse).length}`,
    `Transactions:  ${expenses.length}`,'',
    'CATEGORY BREAKDOWN',
    ...Object.entries(catT).sort((a,b)=>b[1]-a[1]).map(([cat,amt])=>`  ${cat.padEnd(16)} â‚¹${amt.toFixed(2).padStart(10)}  (${total>0?(amt/total*100).toFixed(1):0}%)`),'',
    'DETAILED LOG','â”€'.repeat(44),
    ...[...data].sort((a,b)=>new Date(a.date)-new Date(b.date)).flatMap(e=>{
      const fl=e.type==='transfer'?'[OUTFLOW]':[e.type.toUpperCase(),e.isImpulse?'IMPULSE':''].filter(Boolean).join(' ');
      const rows=[`${e.date}  ${e.category.padEnd(13)} ${e.merchant.padEnd(16)} â‚¹${e.amount.toFixed(2).padStart(8)}  [${fl}]`];
      if (e.note) rows.push(`          Note: ${e.note}`); return rows;
    }),'','â”€'.repeat(44),'Self-check: Did you need all of this? Be honest.',
  ].join('\n');
}
function showReport(){reportText=buildReport();document.getElementById('reportPreview').textContent=reportText;document.getElementById('reportModal').classList.add('show');}
function copyReport(){navigator.clipboard.writeText(reportText).then(()=>toast('ğŸ“‹ Copied!'));}
function sendEmailReport(){
  const email=document.getElementById('inp-email').value.trim();
  if (!email){toast('Enter your email first',true);return;}
  window.location.href=`mailto:${encodeURIComponent(email)}?subject=${encodeURIComponent('Paisa Watch â€” '+MONTHS[viewMonth]+' '+viewYear)}&body=${encodeURIComponent(reportText)}`;
  closeModal('reportModal');toast('ğŸ“§ Opening email clientâ€¦');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  IMPORT PARSER (battle-tested against actual user text)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CAT_KEYWORDS = {
  Food:          ['zomato','swiggy','food','restaurant','cafe','lunch','dinner','breakfast','burger','pizza','biryani','home food','dosa'],
  Groceries:     ['blinkit','zepto','bigbasket','grofers','grocery','groceries','vegetable','milk','bread','home supply','supplies'],
  Entertainment: ['efootball','netflix','prime','hotstar','spotify','game','gaming','cinema','movie','concert'],
  Party:         ['party','birthday','celebration','cake'],
  Gifts:         ['gift','present','amazon','flipkart','myntra'],
  Transport:     ['ola','uber','rapido','metro','bus','auto','cab','petrol','fuel'],
  Impulse:       ['impulse','chocolate','snack','chips','candy'],
};

function guessCat(merchant, section) {
  const t=(merchant+' '+section).toLowerCase();
  for (const [cat,words] of Object.entries(CAT_KEYWORDS)) { if (words.some(w=>t.includes(w))) return cat; }
  return 'Other';
}
function guessImpulseFn(text) { return /impulse|unnecessary|random|craving|sudden|unplanned|urge/.test(text.toLowerCase()); }

function parseImport() {
  const raw=document.getElementById('import-textarea').value.trim();
  const defaultDate=document.getElementById('import-date').value||toDS(new Date());
  if (!raw){toast('Paste some text first',true);return;}
  parsedRows=[];

  const lines=raw.split('\n');

  // Pass 1: find date from "Billed till DD/MM/YYYY"
  let globalDate=defaultDate;
  for (const line of lines) {
    const m=line.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);
    if (m){globalDate=`${m[3]}-${m[2].padStart(2,'0')}-${m[1].padStart(2,'0')}`;break;}
    const m2=line.match(/(\d{4})-(\d{2})-(\d{2})/);
    if (m2){globalDate=m2[0];break;}
  }

  // Pass 2: line-by-line parse
  let currentSection='', currentSectionType='valid', pendingComment='';

  for (const rawLine of lines) {
    const line=rawLine.trim();
    if (!line) continue;

    // Totals â†’ skip
    if (/^=\s*[â‚¹\d]/.test(line)) continue;
    // "Billed till" â†’ skip (date already extracted)
    if (/billed\s+till/i.test(line)) continue;

    const hasRupee=/â‚¹/.test(line);

    // â”€â”€ Comment line: starts with -- â”€â”€
    // Keep ALL content, strip the -- prefix, attach to next merchant entry
    if (/^--/.test(line)) {
      const commentText=line.replace(/^--+\s*/,'').trim();
      if (commentText) pendingComment += (pendingComment?'\n':'')+commentText;
      continue;
    }

    // â”€â”€ Transfer lines: anything that looks like a transfer is Outflow â”€â”€
    const isTransfer = /transfer(red)?/i.test(line) || /\bto\s+me\b/i.test(line);

    if (isTransfer) {
      const amounts=[...line.matchAll(/â‚¹\s*([\d,]+(?:\.\d+)?)/g)].map(m=>parseFloat(m[1].replace(/,/g,''))).filter(v=>v>0);
      // Also catch "To ME :- â‚¹500, â‚¹212" pattern
      const colonAmts=[...line.matchAll(/:-\s*(.+)/gi)].flatMap(m=>[...m[1].matchAll(/â‚¹\s*([\d,]+(?:\.\d+)?)/g)].map(x=>parseFloat(x[1].replace(/,/g,'')))).filter(v=>v>0);
      const allAmts=[...new Set([...amounts,...colonAmts])];
      if (allAmts.length) {
        const comment=pendingComment; pendingComment='';
        allAmts.forEach(amt=>{
          parsedRows.push({date:globalDate,merchant:'Transfer',category:'Transfer',amount:amt,note:comment,type:'transfer',transferDir:'out',isImpulse:false});
        });
      } else {
        pendingComment=''; // reset pending comment if no amounts found
      }
      continue;
    }

    // â”€â”€ Section header with :- at end, NO rupee amounts â”€â”€
    const colonSec=line.match(/^([A-Za-z][A-Za-z &]+?)\s*:-\s*$/);
    if (colonSec && !hasRupee) {
      currentSection=colonSec[1].trim();
      currentSectionType=/stupid|dumb|waste|bad/i.test(currentSection)?'stupid':'valid';
      pendingComment=''; // section change resets pending comment
      continue;
    }

    // â”€â”€ Plain label line (no :-, no â‚¹) â€” section heading â”€â”€
    const isPlainLabel=!hasRupee&&!line.includes(':-')&&/^[A-Za-z][A-Za-z &]+$/.test(line)&&line.length>=4&&line.length<=55;
    if (isPlainLabel) {
      currentSection=line;
      currentSectionType=/stupid|dumb|waste/i.test(line)?'stupid':'valid';
      pendingComment='';
      continue;
    }

    // â”€â”€ Merchant line: "Merchant :- â‚¹x, â‚¹y" â”€â”€
    const merchantMatch=line.match(/^([A-Za-z][A-Za-z 0-9&'.\-]+?)\s*:-\s*(.+)/);
    if (merchantMatch) {
      const merchant=merchantMatch[1].trim();
      const rest=merchantMatch[2];
      const amounts=[...rest.matchAll(/â‚¹\s*([\d,]+(?:\.\d+)?)/g)].map(m=>parseFloat(m[1].replace(/,/g,''))).filter(v=>v>0);

      if (!amounts.length) {
        // Sub-section label
        currentSection=merchant;
        currentSectionType=/stupid|dumb|waste/i.test(merchant)?'stupid':'valid';
        pendingComment='';
        continue;
      }

      // Extract note from parentheses (strip pure numbers/â‚¹)
      const noteM=rest.match(/\(([^)]+)\)/);
      const parenNote=noteM?noteM[1].replace(/[â‚¹\d,.\s]+/g,'').trim():'';

      // Combine paren note + pending comment
      const comment=[parenNote,pendingComment].filter(Boolean).join(' Â· ');
      pendingComment='';

      const type=currentSectionType==='stupid'?'stupid':/stupid|dumb|waste/i.test(line)?'stupid':'valid';
      const impulse=guessImpulseFn(line+' '+currentSection);
      const cat=guessCat(merchant,currentSection);

      amounts.forEach(amt=>{
        parsedRows.push({date:globalDate,merchant,category:cat,amount:amt,note:comment,type,isImpulse:impulse,transferDir:null});
      });
      continue;
    }
  }

  if (!parsedRows.length){toast('Could not parse any expenses â€” check format',true);return;}
  renderPreview();
}

function renderPreview() {
  const tbody=document.getElementById('previewBody');
  document.getElementById('previewCount').textContent=parsedRows.length+' entr'+(parsedRows.length===1?'y':'ies')+' found';
  tbody.innerHTML=parsedRows.map((row,idx)=>{
    const isTransfer=row.type==='transfer';
    const typeLabel=isTransfer?'â†— Outflow':(row.type==='valid'?'âœ… Valid':'ğŸ¤¦ Stupid');
    const typeCls=isTransfer?'transfer-out':row.type;
    const catOptions=Object.keys(CAT_META).map(c=>`<option value="${c}" ${c===row.category?'selected':''}>${CAT_META[c].icon} ${c}</option>`).join('');
    return `<tr id="prow-${idx}">
      <td><input class="ec" type="date" value="${row.date}" onchange="parsedRows[${idx}].date=this.value"></td>
      <td><input class="ec" type="text" value="${esc(row.merchant)}" onchange="parsedRows[${idx}].merchant=this.value"></td>
      <td><select class="ec" onchange="parsedRows[${idx}].category=this.value">${catOptions}</select></td>
      <td><input class="ec" type="number" value="${row.amount}" style="width:80px" onchange="parsedRows[${idx}].amount=parseFloat(this.value)||0"></td>
      <td><div class="comment-preview" title="${esc(row.note||'')}">${row.note?esc(row.note):'<span style="color:var(--muted)">â€”</span>'}</div></td>
      <td><button class="type-pill ${typeCls}" id="tpill-${idx}" onclick="${isTransfer?'':  `toggleRowType(${idx})`}">${typeLabel}</button></td>
      <td><button class="rm-row" onclick="removePreviewRow(${idx})">âœ•</button></td>
    </tr>`;
  }).join('');
  document.getElementById('previewBox').style.display='block';
  document.getElementById('previewBox').scrollIntoView({behavior:'smooth',block:'start'});
}

function toggleRowType(idx) {
  parsedRows[idx].type=parsedRows[idx].type==='valid'?'stupid':'valid';
  const btn=document.getElementById('tpill-'+idx);
  btn.className='type-pill '+parsedRows[idx].type;
  btn.textContent=parsedRows[idx].type==='valid'?'âœ… Valid':'ğŸ¤¦ Stupid';
}
function removePreviewRow(idx){parsedRows.splice(idx,1);if(!parsedRows.length){cancelImport();return;}renderPreview();}
function cancelImport(){parsedRows=[];document.getElementById('previewBox').style.display='none';}

function confirmImport() {
  if (!parsedRows.length) return;
  const valid=parsedRows.filter(r=>r.amount>0&&r.merchant.trim());
  if (!valid.length){toast('No valid rows',true);return;}
  valid.forEach(row=>{
    STATE.expenses.push({
      id:Date.now()+Math.random(),
      accountId:STATE.activeAccountId,
      date:row.date, merchant:row.merchant.trim(), category:row.category,
      amount:row.amount, note:row.note||'', type:row.type,
      isImpulse:row.isImpulse||false, transferDir:row.transferDir||null,
    });
  });
  save();
  const d=new Date(valid[0].date+'T00:00:00'); viewYear=d.getFullYear(); viewMonth=d.getMonth();
  cancelImport();
  document.getElementById('import-textarea').value='';
  toast(`âœ… Imported ${valid.length} expense${valid.length!==1?'s':''}`);
  const dashBtn=document.querySelector('.main-tab');
  switchTab('dashboard',dashBtn); render();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  KEYBOARD + START
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('keydown',e=>{
  if (e.ctrlKey&&e.key==='Enter') addExpense();
  if (e.key==='Escape') { closeModal('reportModal'); closeAccModal(); }
});
// init() is called from firebase-ready handler (after auth) or skipToLocal()
</script>
</body>
</html>
